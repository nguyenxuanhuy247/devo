<div [formGroup]="formGroup" class="container grid">
  <div class="col-12">
    <div class="card flex justify-content-between">
      <p-select
        [formControlName]="SELECT_FORM_GROUP_KEY.employee"
        [options]="employeeOptions()"
        placeholder="Chọn tên nhân viên" />

      <p-select
        [formControlName]="SELECT_FORM_GROUP_KEY.project"
        [options]="getDependentProjectDropDown(SELECT_FORM_GROUP_KEY.employee)"
        placeholder="Chọn dự án" />


      <span>Thống kê theo : </span>
      <p-togglebutton
        [formControlName]="FORM_GROUP_KEYS.quickDateRange"
        offLabel="Hôm nay"
        onLabel="Hôm nay"
        styleClass="w-24"></p-togglebutton>
      <p-togglebutton
        [formControlName]="FORM_GROUP_KEYS.quickDateRange"
        offLabel="Tuần này"
        onLabel="Tuần này"
        styleClass="w-24"></p-togglebutton>
      <p-togglebutton
        [formControlName]="FORM_GROUP_KEYS.quickDateRange"
        offLabel="Tháng này"
        onLabel="Tháng này"
        styleClass="w-24"></p-togglebutton>
      <p-datepicker
        [formControlName]="SELECT_FORM_GROUP_KEY.dateRange"
        selectionMode="range"></p-datepicker>
    </div>
  </div>

  <div class="col-12">
    <p-tabs (valueChange)="onTabChange($event)" [value]="activeTabIndex()">
      <p-tablist>
        <p-tab [value]="0">Dự toán</p-tab>
        <p-tab [value]="1">Log work</p-tab>
        <p-tab [value]="2">Vấn đề</p-tab>
        <p-tab [value]="3">Bug & Improvement</p-tab>
      </p-tablist>
      <p-tabpanels>
        <p-tabpanel [value]="activeTabIndex()">
          <div class="flex justify-content-end">
            <p-splitbutton
              (onClick)="onAddNewRow()"
              [model]="createButtonMenu"
              icon="pi pi-plus"
              label="Thêm mới" />
          </div>
          <ng-container *ngTemplateOutlet="tableDataTemplate"></ng-container>
        </p-tabpanel>
      </p-tabpanels>
    </p-tabs>
  </div>
</div>

<p-blockui [blocked]="isLoading()">
  <p-progress-spinner ariaLabel="loading" />
</p-blockui>


<ng-template #tableDataTemplate>
  <div [formGroup]="formGroup">
    <p-table
      [value]="formArrayObservable | async"
      responsiveLayout="scroll"
    >
      <ng-template pTemplate="header">
        <tr>
          @for (col of headerColumns(); track col.value) {
            <th>{{ col.label }}</th>
          }
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-rowData let-index="rowIndex">
        <tr>
          @if (rowData.mode === EMode.VIEW) {
            @for (col of headerColumns(); track col.value) {
              <!-- Chế độ VIEW chỉ hiển thị text -->
              @if (col.value === COLUMN_FIELD.startTime || col.value === COLUMN_FIELD.endTime) {
                <td>{{ rowData[col.value] | formatDate }}</td>
              } @else if (col.value === COLUMN_FIELD.actions) {
                <td>
                  <div class="flex align-items-center justify-content-between gap-1">
                    <p-button
                      variant="outlined" severity="secondary" size="small" icon="pi pi-file-edit"
                      aria-label="Chỉnh sửa" pTooltip="Chỉnh sửa" tooltipPosition="bottom" />
                    <p-button
                      variant="outlined" severity="secondary" size="small" icon="pi pi-trash" aria-label="Xóa"
                      pTooltip="Xóa" tooltipPosition="bottom" />
                  </div>
                </td>
              } @else {
                <td>{{ rowData[col.value] }}</td>
              }
            }
          } @else {
            <!-- Chế độ CREATE / UPDATE hiển thị form -->
            <td>
              <p-select
                [formControl]="getFormControl(index, FORM_GROUP_KEYS.module)"
                [options]="getDependentModuleDropDown(index, FORM_GROUP_KEYS.project)"
                optionLabel="label"
                optionValue="value"
                appendTo="body"
              ></p-select>
            </td>

            <td>
              <p-select
                [formControl]="getFormControl(index, FORM_GROUP_KEYS.menu)"
                [options]="getDependentMenuDropDown(index, FORM_GROUP_KEYS.module)"
                optionLabel="label"
                optionValue="value"
                appendTo="body"
              ></p-select>
            </td>

            <td>
              <p-select
                [formControl]="getFormControl(index, FORM_GROUP_KEYS.screen)"
                [options]="[{label: 'aaaaaa', value: 'aaaaaa'}]"
                optionLabel="label"
                optionValue="value"
                appendTo="body"
              ></p-select>
            </td>

            <td>
              <p-select
                [formControl]="getFormControl(index, FORM_GROUP_KEYS.feature)"
                [options]="[{label: 'aaaaaa', value: 'aaaaaa'}]"
                optionLabel="label"
                optionValue="value"
                appendTo="body"
              ></p-select>
            </td>

            <td>
              <p-select
                [formControl]="getFormControl(index, FORM_GROUP_KEYS.category)"
                [options]="[{label: 'aaaaaa', value: 'aaaaaa'}]"
                optionLabel="label"
                optionValue="value"
                appendTo="body"
              ></p-select>
            </td>

            <td>
                  <textarea
                    [formControl]="getFormControl(index, FORM_GROUP_KEYS.category)"
                    rows="5"
                    cols="30"
                    pTextarea
                    placeholder="Nhập nội dung công việc"
                  ></textarea>
            </td>

            <td>
              <p-datepicker
                [formControl]="getFormControl(index, FORM_GROUP_KEYS.startTime)"
                [showTime]="true"
                hourFormat="24"
                dateFormat="HH:mm dd/mm"
                appendTo="body"
              ></p-datepicker>
            </td>

            <td>
              <p-datepicker
                [formControl]="getFormControl(index, FORM_GROUP_KEYS.endTime)"
                [showTime]="true"
                hourFormat="24"
                dateFormat="HH:mm dd/mm"
                appendTo="body"
              ></p-datepicker>
            </td>

            <td>
              <p-inputnumber
                [formControl]="getFormControl(index, FORM_GROUP_KEYS.duration)"
                mode="decimal"
                [minFractionDigits]="2"
                [maxFractionDigits]="5"
                [useGrouping]="false"></p-inputnumber>
            </td>

            <td>
              <p-checkbox
                [formControl]="getFormControl(index, FORM_GROUP_KEYS.isLunchBreak)"
                [binary]="true"
              />
            </td>

            <td>
              <p-checkbox
                [formControl]="getFormControl(index, FORM_GROUP_KEYS.isSolveIssue)"
                [binary]="true"
              />
            </td>

            <td>
              <p-select
                [formControl]="getFormControl(index, FORM_GROUP_KEYS.encounteredIssue)"
                [options]="[{label: 'aaaaaa', value: 'aaaaaa'}]"
                optionLabel="label"
                optionValue="value"
                appendTo="body"
              ></p-select>
            </td>

            <td>
              <div class="flex align-items-center justify-content-between gap-1">
                <p-button
                  variant="outlined"
                  severity="secondary"
                  size="small"
                  icon="pi pi-times"
                  aria-label="Hủy"
                  pTooltip="Hủy"
                  tooltipPosition="bottom"
                  (click)="onCancelCreate()"
                />
                <p-button
                  variant="outlined"
                  severity="secondary"
                  size="small"
                  icon="pi pi-save"
                  aria-label="Lưu"
                  pTooltip="Lưu"
                  tooltipPosition="bottom"
                  (click)="onCreate()"
                />
              </div>
            </td>
          }
        </tr>
      </ng-template>
    </p-table>
  </div>
</ng-template>
