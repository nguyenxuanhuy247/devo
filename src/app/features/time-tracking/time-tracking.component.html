<div [formGroup]="formGroup" class="container grid">
  <div class="w-full flex gap-3">
    <!-- BÊN TRÁI -->
    <div class="flex flex-1 gap-3">
      <div class="flex-1">
        <label for="employee" class="">Nhân viên</label>
        <div class="">
          <p-select
            id="employee"
            [formControlName]="SELECT_FORM_GROUP_KEY.employee"
            [options]="employeeOptions()"
          />
        </div>
      </div>

      <div class="flex-1">
        <label for="project" class="">Dự án</label>
        <div class="">
          <p-select
            id="project"
            [formControlName]="SELECT_FORM_GROUP_KEY.project"
            [options]="getDependentProjectDropDown(SELECT_FORM_GROUP_KEY.employee)"
          />
        </div>
      </div>
    </div>

    <!-- BÊN PHẢI -->
    <div class="flex-1 flex-col">
      <span class="block">Thống kê theo : </span>
      <div class="flex gap-3">
        <div class="flex flex-wrap gap-4">
          <div class="flex items-center">
            <p-radiobutton
              value="TODAY"
              [formControlName]="SELECT_FORM_GROUP_KEY.quickDate"
              inputId="today"></p-radiobutton>
            <label for="today" class="ml-2">Hôm nay</label>
          </div>

          <div class="flex items-center">
            <p-radiobutton
              value="WEEK"
              [formControlName]="SELECT_FORM_GROUP_KEY.quickDate"
              inputId="week"></p-radiobutton>
            <label for="week" class="ml-2">Tuần này</label>
          </div>

          <div class="flex items-center">
            <p-radiobutton
              value="MONTH"
              [formControlName]="SELECT_FORM_GROUP_KEY.quickDate"
              inputId="month"></p-radiobutton>
            <label for="month" class="ml-2">Tháng này</label>
          </div>

          <div class="flex items-center">
            <p-radiobutton
              value="CUSTOM"
              [formControlName]="SELECT_FORM_GROUP_KEY.quickDate"
              inputId="custom"></p-radiobutton>
            <label for="custom" class="ml-2">Tùy chỉnh</label>
          </div>
        </div>

        <p-datepicker
          class="ml-auto"
          [formControlName]="SELECT_FORM_GROUP_KEY.dateRange"
          dateFormat="dd/mm/yy"
          selectionMode="range"></p-datepicker>
      </div>
    </div>

    <p-button label="Tải lại" icon="pi pi-refresh" (click)="onReload()" />
  </div>


  <div class="col-12">
    <p-tabs (valueChange)="onChangeTab($event)" [value]="activeTab()">
      <p-tablist>
        <p-tab [value]="ETabName.ESTIMATE">Dự toán</p-tab>
        <p-tab [value]="ETabName.LOG_WORK">Log work</p-tab>
        <p-tab [value]="ETabName.ISSUE">Vấn đề</p-tab>
        <p-tab [value]="ETabName.BUG">Bug</p-tab>
        <p-tab [value]="ETabName.IMPROVEMENT">Improvement</p-tab>
        <p-tab [value]="ETabName.FIX_BUG_DO_IMPROVEMENT">Fix Bug & Do Improvement</p-tab>
      </p-tablist>
      <p-tabpanels>
        <p-tabpanel [value]="activeTab()">
          <!-- Nút Thêm mới -->
          @if (mode() === EMode.VIEW) {
            <div class="flex justify-content-end gap-3">
              @if (activeTab() === ETabName.FIX_BUG_DO_IMPROVEMENT) {
                <p-button
                  [outlined]="true"
                  severity="secondary"
                  icon="pi pi-external-link"
                  pTooltip="Mở rộng trang tính"
                  label="Mở trang tính"
                  (click)="openGoogleSheets()"
                />

                <p-button
                  [outlined]="true"
                  severity="secondary"
                  icon="pi pi-sync"
                  pTooltip="Tải lại danh sách"
                  label="Tải lại danh sách"
                  (click)="checkForFixBugAndImprovementUpdates()"
                />
              }

              <!-- TODO - Bổ sung sau -->
              <p-button
                *ngIf="false"
                icon="pi pi-plus"
                label="Xóa hàng loạt"
                (click)="onBulkDelete()"
              />

              @if (activeTab() === ETabName.ESTIMATE || activeTab() === ETabName.FIX_BUG_DO_IMPROVEMENT) {
                <p-button
                  icon="pi pi-plus"
                  label="Thêm hàng loạt"
                  (click)="onBulkCreate()"
                />
              }
            </div>
          }
          <ng-container *ngTemplateOutlet="tableDataTemplate"></ng-container>
        </p-tabpanel>
      </p-tabpanels>
    </p-tabs>
  </div>
</div>

<p-blockui [blocked]="isLoading()">
  <p-progress-spinner ariaLabel="loading" />
</p-blockui>

<!-- TEMPLATE CỦA TABLE -->
<ng-template #tableDataTemplate>
  <div>
    <div class="huynx15-table">
      <p-table
        [frozenValue]="mode() === EMode.VIEW ? fixedRowData : []"
        [value]="tableData"
        [scrollable]="true"
        styleClass="p-datatable-gridlines"
        scrollHeight="800px"
      >
        <!-- TABLE HEADER -->
        <ng-template pTemplate="header">
          <tr>
            @for (col of headerColumns(); track trackBy(col)) {
              @if (col.field === COLUMN_FIELD.category) {
                <th pResizableColumn pFrozenColumn [style.min-width.px]="col.minWidth">
                  <div class="line-clamp line-clamp-2">
                    {{ col.label }}
                  </div>
                </th>
              } @else {
                <th pResizableColumn [style.min-width.px]="col.minWidth">
                  <div class="line-clamp line-clamp-2">{{ col.label }}</div>
                </th>
              }
            }
          </tr>
        </ng-template>

        <!--  TABLE : DÒNG THÊM MỚI -->
        <ng-template pTemplate="frozenbody" let-rowData let-index="rowIndex">
          <tr [formGroup]="createFormGroup">
            <td>
              <div class="flex align-items-center justify-content-between gap-1">
                <p-button
                  variant="outlined"
                  severity="secondary"
                  size="small"
                  icon="pi pi-save"
                  aria-label="Lưu"
                  pTooltip="Lưu"
                  tooltipPosition="bottom"
                  (click)="onSaveCreate()"
                />
              </div>
            </td>

            <td>
              <div>
                <lib-form-select
                  [formControlName]="FORM_GROUP_KEYS.module"
                  [options]="getDependentModuleDropDown(FORM_GROUP_KEYS.project)"
                ></lib-form-select>
              </div>
            </td>

            <td>
              <div>
                <lib-form-select
                  [formControlName]="FORM_GROUP_KEYS.menu"
                  [options]="getDependentDropDown(index, rowData, FORM_GROUP_KEYS.module)"
                ></lib-form-select>
              </div>
            </td>

            <td>
              <div>
                <lib-form-select
                  [formControlName]="FORM_GROUP_KEYS.screen"
                  [options]="getDependentDropDown(index, rowData, FORM_GROUP_KEYS.menu)"
                ></lib-form-select>
              </div>
            </td>

            <td>
              <div>
                <lib-form-select
                  [formControlName]="FORM_GROUP_KEYS.feature"
                  [options]="getDependentDropDown(index, rowData, FORM_GROUP_KEYS.screen)"
                ></lib-form-select>
              </div>
            </td>

            <td>
              <div>
                <lib-form-select
                  [formControlName]="FORM_GROUP_KEYS.category"
                  [options]="independentDropdowns().categories || []"
                ></lib-form-select>
              </div>
            </td>

            @if (activeTab() === ETabName.LOG_WORK) {
              <td>
                <div>
                  <textarea
                    pTextarea
                    [formControlName]="FORM_GROUP_KEYS.workContent"
                    rows="1"
                    cols="30"
                  ></textarea>
                </div>
              </td>

              <td>
                <div>
                  <p-select
                    [formControlName]="FORM_GROUP_KEYS.encounteredIssue"
                    [options]="[{label: 'aaaaaa', value: 'aaaaaa'}]"
                    optionLabel="label"
                    optionValue="value"
                    appendTo="body"
                  ></p-select>
                </div>
              </td>
            }

            @if (activeTab() === ETabName.ISSUE) {
              <td>
                <div>
                  <p-select
                    [formControlName]="FORM_GROUP_KEYS.departmentMakeIssue"
                    [options]="independentDropdowns().departments || []"
                    optionLabel="label"
                    optionValue="value"
                    appendTo="body"
                  ></p-select>
                </div>
              </td>

              <td>
                <div>
                  <p-select
                    [formControlName]="FORM_GROUP_KEYS.interruptionReason"
                    [options]="getDependentDropDown(index, rowData, FORM_GROUP_KEYS.departmentMakeIssue)"
                    optionLabel="label"
                    optionValue="value"
                    appendTo="body"
                  ></p-select>
                </div>
              </td>

              <td>
                <div>
                  <textarea
                    [formControlName]="FORM_GROUP_KEYS.encounteredIssue"
                    rows="1"
                    cols="30"
                    pTextarea
                  ></textarea>
                </div>
              </td>

              <td>
                <div>
                  <p-select
                    [formControlName]="FORM_GROUP_KEYS.employeeMakeIssue"
                    [options]="employeeOptions()"
                    optionLabel="label"
                    optionValue="value"
                    appendTo="body"
                  ></p-select>
                </div>
              </td>

              <td>
                <div>
                  <p-checkbox
                    [formControlName]="FORM_GROUP_KEYS.isProgressBlock"
                    [binary]="true"
                  />
                </div>
              </td>
            }

            @if (activeTab() === ETabName.FIX_BUG_DO_IMPROVEMENT) {
              <td>
                <!-- Mã bug & improvement -->
              </td>
            }

            <td>
              <div class="flex align-items-center justify-content-center gap-1">
                <p-button
                  variant="outlined"
                  severity="secondary"
                  size="small"
                  icon="pi pi-clock"
                  aria-label="Thời gian hiện tại"
                  pTooltip="Thời gian hiện tại"
                  tooltipPosition="bottom"
                  (click)="onSetCurrentTimeForDatepicker(index, FORM_GROUP_KEYS.startTime)"
                />
                <p-datepicker
                  [formControlName]="FORM_GROUP_KEYS.startTime"
                  [showTime]="true"
                  hourFormat="24"
                  dateFormat="dd/mm"
                  appendTo="body"
                >
                </p-datepicker>
              </div>
            </td>

            <td>
              <div class="flex align-items-center justify-content-center gap-1">
                <p-button
                  variant="outlined"
                  severity="secondary"
                  size="small"
                  icon="pi pi-clock"
                  aria-label="Thời gian hiện tại"
                  pTooltip="Thời gian hiện tại"
                  tooltipPosition="bottom"
                  (click)="onSetCurrentTimeForDatepicker(index, FORM_GROUP_KEYS.endTime)"
                />

                <p-datepicker
                  [formControlName]="FORM_GROUP_KEYS.endTime"
                  [showTime]="true"
                  hourFormat="24"
                  dateFormat="dd/mm"
                  appendTo="body"
                >
                </p-datepicker>
              </div>
            </td>

            <td>
              <div>
                <input
                  pInputText
                  appWorkDuration
                  [formControlName]="FORM_GROUP_KEYS.duration"
                  [formGroup]="createFormGroup"
                /></div>
            </td>

            @if (activeTab() === ETabName.LOG_WORK) {
              <td>
                <div>
                  <p-checkbox
                    [formControlName]="FORM_GROUP_KEYS.isLunchBreak"
                    [binary]="true"
                  />
                </div>
              </td>
            }

            @if (activeTab() === ETabName.ISSUE) {
              <td>
                <div>
                  <p-select
                    [formControlName]="FORM_GROUP_KEYS.status"
                    [options]="[{label: 'Trạng thái 1', value: 'aaaaaa'}]"
                    optionLabel="label"
                    optionValue="value"
                    appendTo="body"
                  ></p-select>
                </div>
              </td>           
            }

            <!-- Danh sách nút hành động của Thêm mới -->
            <td>
              <div class="flex align-items-center justify-content-between gap-1">
                <p-button
                  variant="outlined"
                  severity="secondary"
                  size="small"
                  icon="pi pi-times"
                  aria-label="Xóa dữ liệu"
                  pTooltip="Xóa dữ liệu"
                  tooltipPosition="bottom"
                  (click)="onResetCreateForm()"
                />
                <p-button
                  variant="outlined"
                  severity="secondary"
                  size="small"
                  icon="pi pi-save"
                  aria-label="Lưu"
                  pTooltip="Lưu"
                  tooltipPosition="bottom"
                  (click)="onSaveCreate()"
                />
              </div>
            </td>
          </tr>
        </ng-template>


        <!--  TABLE ROW DATA -->
        <ng-template pTemplate="body" let-rowData let-index="rowIndex">
          @if (rowData.mode === EMode.VIEW) {
            <!-- Chế độ VIEW chỉ hiển thị text -->
            <tr>
              @for (col of headerColumns(); track col.field) {
                @if (col.field === COLUMN_FIELD.no) {
                  <td>{{ index + 1 }}</td>
                } @else if (col.field === COLUMN_FIELD.startTime || col.field === COLUMN_FIELD.endTime) {
                  <td>{{ rowData[col.field] | formatDate }}</td>
                } @else if (col.field === COLUMN_FIELD.duration) {
                  <td>{{ rowData[col.field] | roundNumber }}</td>
                } @else if (col.field === COLUMN_FIELD.actions) {
                  <td>
                    <div class="flex align-items-center justify-content-between gap-1">
                      @if (activeTab() === ETabName.ISSUE) {
                        <p-button
                          variant="outlined"
                          severity="secondary"
                          size="small"
                          icon="pi pi-check-square"
                          aria-label="Đánh dấu đã xong"
                          pTooltip="Đánh dấu đã xong"
                          tooltipPosition="bottom"
                          (click)="onMarkFinish()"
                        />
                      }

                      <p-button
                        variant="outlined"
                        severity="secondary"
                        size="small"
                        icon="pi pi-file-edit"
                        aria-label="Chỉnh sửa"
                        pTooltip="Chỉnh sửa"
                        tooltipPosition="bottom"
                        (click)="onChangeToUpdateMode(index)"
                      />
                      <p-button
                        variant="outlined"
                        severity="secondary"
                        size="small"
                        icon="pi pi-trash"
                        aria-label="Xóa"
                        pTooltip="Xóa"
                        tooltipPosition="bottom"
                        (click)="onDelete(rowData)"
                      />
                    </div>
                  </td>
                } @else {
                  <td>
                    <div class="line-clamp line-clamp-1" [pTooltip]="rowData[col.field]">{{ rowData[col.field] }}</div>
                  </td>
                }
              }
            </tr>
          } @else {
            <!-- Hiển thị Form Update -->
            <tr [formGroup]="getFormGroup(index)">
              <td>
                <div>{{ index + 1 }}</div>
              </td>
              <td>
                <div>
                  <p-select
                    [formControlName]="FORM_GROUP_KEYS.module"
                    [options]="getDependentModuleDropDown(FORM_GROUP_KEYS.project)"
                    optionLabel="label"
                    optionValue="value"
                    appendTo="body"
                  ></p-select>
                </div>
              </td>

              <td>
                <div>
                  <p-select
                    [formControlName]="FORM_GROUP_KEYS.menu"
                    [options]="getDependentDropDown(index, rowData, FORM_GROUP_KEYS.module)"
                    optionLabel="label"
                    optionValue="value"
                    appendTo="body"
                  ></p-select>
                </div>
              </td>

              <td>
                <div>
                  <p-select
                    [formControlName]="FORM_GROUP_KEYS.screen"
                    [options]="getDependentDropDown(index, rowData, FORM_GROUP_KEYS.menu)"
                    optionLabel="label"
                    optionValue="value"
                    appendTo="body"
                  ></p-select>
                </div>
              </td>

              <td>
                <div>
                  <p-select
                    [formControl]="getFormControl(index, FORM_GROUP_KEYS.feature)"
                    [options]="getDependentDropDown(index, rowData, FORM_GROUP_KEYS.screen)"
                    optionLabel="label"
                    optionValue="value"
                    appendTo="body"
                  ></p-select>
                </div>
              </td>

              <td>
                <div>
                  <p-select
                    [formControlName]="FORM_GROUP_KEYS.category"
                    [options]="independentDropdowns().categories"
                    optionLabel="label"
                    optionValue="value"
                    appendTo="body"
                  ></p-select>
                </div>
              </td>

              @if (activeTab() === ETabName.LOG_WORK) {
                <td>
                  <div>
                    <textarea
                      [formControl]="getFormControl(index, FORM_GROUP_KEYS.workContent)"
                      rows="1"
                      cols="30"
                      pTextarea
                    ></textarea>
                  </div>
                </td>

                <td>
                  <div>
                    <p-select
                      [formControlName]="FORM_GROUP_KEYS.encounteredIssue"
                      [options]="[{label: 'Vấn đề gặp phải 1', value: 'aaaaaa'}]"
                      optionLabel="label"
                      optionValue="value"
                      appendTo="body"
                    ></p-select>
                  </div>
                </td>
              }

              @if (activeTab() === ETabName.ISSUE) {
                <td>
                  <div>
                    <p-select
                      [formControlName]="FORM_GROUP_KEYS.departmentMakeIssue"
                      [options]="independentDropdowns().departments || []"
                      optionLabel="label"
                      optionValue="value"
                      appendTo="body"
                    ></p-select>
                  </div>
                </td>
  
                <td>
                  <div>
                    <p-select
                      [formControlName]="FORM_GROUP_KEYS.interruptionReason"
                      [options]="[{label: 'Tài liệu sai', value: 'aaaaaa'}]"
                      optionLabel="label"
                      optionValue="value"
                      appendTo="body"
                    ></p-select>
                  </div>
                </td>
  
                <td>
                  <div>
                    <textarea
                      [formControlName]="FORM_GROUP_KEYS.encounteredIssue"
                      rows="1"
                      cols="30"
                      pTextarea
                    ></textarea>
                  </div>
                </td>
  
                <td>
                  <div>
                    <p-select
                      [formControlName]="FORM_GROUP_KEYS.employeeMakeIssue"
                      [options]="[{label: 'Anh Thư', value: 'aaaaaa'}]"
                      optionLabel="label"
                      optionValue="value"
                      appendTo="body"
                    ></p-select>
                  </div>
                </td>
  
                <td>
                  <div>
                    <p-checkbox
                      [formControlName]="FORM_GROUP_KEYS.isProgressBlock"
                      [binary]="true"
                    />
                  </div>
                </td>
              }
  
              <!-- Thời gian bắt đầu -->
              <td>
                <div class="flex align-items-center justify-content-center gap-1">
                  <p-button
                    variant="outlined"
                    severity="secondary"
                    size="small"
                    icon="pi pi-clock"
                    aria-label="Thời gian hiện tại"
                    pTooltip="Thời gian hiện tại"
                    tooltipPosition="bottom"
                    (click)="onSetCurrentTimeForDatepicker(index, FORM_GROUP_KEYS.startTime)"
                  />
                  <p-datepicker
                    [formControlName]="FORM_GROUP_KEYS.startTime"
                    [showTime]="true"
                    hourFormat="24"
                    dateFormat="dd/mm"
                    appendTo="body"
                  >
                  </p-datepicker>
                </div>
              </td>

              <!-- Thời gian hoàn thành -->
              <td>
                <div class="flex align-items-center justify-content-center gap-1">
                  <p-button
                    variant="outlined"
                    severity="secondary"
                    size="small"
                    icon="pi pi-clock"
                    aria-label="Thời gian hiện tại"
                    pTooltip="Thời gian hiện tại"
                    tooltipPosition="bottom"
                    (click)="onSetCurrentTimeForDatepicker(index, FORM_GROUP_KEYS.endTime)"
                  />

                  <p-datepicker
                    [formControlName]="FORM_GROUP_KEYS.endTime"
                    [showTime]="true"
                    hourFormat="24"
                    dateFormat="dd/mm"
                    appendTo="body"
                  >
                  </p-datepicker>
                </div>
              </td>

              <td>
                <div>
                  <input
                    appWorkDuration
                    [formControlName]="FORM_GROUP_KEYS.duration"
                    id="duration"
                    pInputText
                    [formGroup]="getFormGroup(index)"
                  /></div>
              </td>

              @if (activeTab() === ETabName.LOG_WORK) {
                <td>
                  <div>
                    <p-checkbox
                      [formControlName]="FORM_GROUP_KEYS.isLunchBreak"
                      [binary]="true"
                    />
                  </div>
                </td>
              }

              @if (activeTab() === ETabName.ISSUE) {
                <td>
                  <div>
                    <p-select
                      [formControlName]="FORM_GROUP_KEYS.status"
                      [options]="[{label: 'Trạng thái 1', value: 'aaaaaa'}]"
                      optionLabel="label"
                      optionValue="value"
                      appendTo="body"
                    ></p-select>
                  </div>
                </td>           
              }
  
              <td>
                <div class="flex align-items-center justify-content-between gap-1">
                  <p-button
                    variant="outlined"
                    severity="secondary"
                    size="small"
                    icon="pi pi-times"
                    aria-label="Hủy"
                    pTooltip="Hủy"
                    tooltipPosition="bottom"
                    (click)="onCancelUpdateMode(index)"
                  />
                  <p-button
                    variant="outlined"
                    severity="secondary"
                    size="small"
                    icon="pi pi-save"
                    aria-label="Lưu"
                    pTooltip="Lưu"
                    tooltipPosition="bottom"
                    (click)="onSaveUpdate(index)"
                  />
                </div>
              </td>
            </tr>
          }
        </ng-template>
      </p-table>
    </div>
  </div>
</ng-template>

<p-confirmdialog></p-confirmdialog>