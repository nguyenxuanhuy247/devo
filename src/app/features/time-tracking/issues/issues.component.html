<div class="issues">
  <div class="log-work">
    <p-table
      [frozenValue]="mode() === EMode.VIEW ? fixedRowData : []"
      [value]="formArray.controls"
      [scrollable]="true"
      styleClass="p-datatable-gridlines"
      scrollHeight="800px"
      [resizableColumns]="true"
      columnResizeMode="expand"
      dataKey="id"
    >
      <!-- TABLE HEADER -->
      <ng-template pTemplate="header">
        <tr>
          <td>ssss</td>
          @for (col of headerColumnConfigs; track col.field) {
            @if (col.field
            === COLUMN_FIELD.categoryId) {
              <th
                [pSortableColumn]="col.field"
                pResizableColumn
                pFrozenColumn
                [style.min-width.px]="col.minWidth"
              >
                <div class="flex">
                  <div class="flex-1 line-clamp line-clamp-2">
                    {{ col.label }}
                  </div>
                  <p-sortIcon [field]="col.field" />
                </div>
              </th>
            } @else {
              <th
                [pSortableColumn]="col.field"
                pResizableColumn
                [style.min-width.px]="col.minWidth"
              >
                <div class="flex">
                  <div
                    class="flex-1 line-clamp line-clamp-2"
                    [pTooltip]="col.label"
                  >
                    {{ col.label }}
                  </div>
                  <p-sortIcon [field]="col.field" />
                </div>
              </th>
            }
          }
        </tr>
      </ng-template>

      <!--  TABLE : DÒNG THÊM MỚI -->
      <ng-template
        pTemplate="frozenbody"
        let-rowData
        let-index="rowIndex"
      >
        <tr [formGroup]="createFormGroup">
          <td>hhh</td>
          <td>
            <div class="flex align-items-center justify-content-between gap-1">
              <p-button
                variant="outlined"
                severity="secondary"
                size="small"
                icon="pi pi-save"
                aria-label="Lưu"
                pTooltip="Lưu"
                tooltipPosition="bottom"
                (click)="onSaveCreate()"
              />
            </div>
          </td>

          <td>
            <div>
              <lib-form-select
                #moduleId
                [formControlName]="FORM_GROUP_KEYS.moduleId"
                [options]="(moduleDependentOptions$ | async)?.[projectFormControl().value]"
              ></lib-form-select>
            </div>
          </td>

          <td>
            <div>
              <lib-form-select
                #menuId
                [formControlName]="FORM_GROUP_KEYS.menuId"
                [options]="(menuDependentOptions$ | async)?.[moduleId.value]"
              ></lib-form-select>
            </div>
          </td>

          <td>
            <div>
              <lib-form-select
                #screenId
                [formControlName]="FORM_GROUP_KEYS.screenId"
                [options]="(screenDependentOptions$ | async)?.[menuId.value]"
              ></lib-form-select>
            </div>
          </td>

          <td>
            <div>
              <lib-form-select
                [formControlName]="FORM_GROUP_KEYS.featureId"
                [options]="(featureDependentOptions$ | async)?.[screenId.value]"
              ></lib-form-select>
            </div>
          </td>

          <td>
            <div>
              <lib-form-select
                [formControlName]="FORM_GROUP_KEYS.categoryId"
                [options]="(categoryOptions$ | async) || []"
              ></lib-form-select>
            </div>
          </td>

          <td>
            <div>
              <textarea
                pTextarea
                [formControlName]="FORM_GROUP_KEYS.issueName"
                rows="1"
                cols="30"
              ></textarea>
            </div>
          </td>

          <td>
            <div>
              <lib-form-select
                [formControlName]="FORM_GROUP_KEYS.departmentMakeId"
                [options]="(categoryOptions$ | async) || []"
              ></lib-form-select>
            </div>
          </td>


          <td>
            <div>
              <lib-form-select
                [formControlName]="FORM_GROUP_KEYS.employeeMakeId"
                [options]="(categoryOptions$ | async) || []"
              ></lib-form-select>
            </div>
          </td>

          <td>
            <div>
              <lib-form-select
                [formControlName]="FORM_GROUP_KEYS.interruptionReasonId"
                [options]="(categoryOptions$ | async) || []"
              ></lib-form-select>
            </div>
          </td>

          <td>
            <div>
              <lib-form-select
                [formControlName]="FORM_GROUP_KEYS.deadlineId"
                [options]="(categoryOptions$ | async) || []"
              ></lib-form-select>
            </div>
          </td>

          <td>
            <div class="flex align-items-center justify-content-center gap-1">
              <p-button
                variant="outlined"
                severity="secondary"
                size="small"
                icon="pi pi-clock"
                aria-label="Thời gian hiện tại"
                pTooltip="Thời gian hiện tại"
                tooltipPosition="bottom"
                (click)="
                  onSetCurrentTimeForDatepicker(
                    index,
                    FORM_GROUP_KEYS.startTime
                  )
                "
              />
              <p-datepicker
                [formControlName]="FORM_GROUP_KEYS.startTime"
                [showTime]="true"
                hourFormat="24"
                dateFormat="dd/mm"
                appendTo="body"
              >
              </p-datepicker>
            </div>
          </td>

          <td>
            <div class="flex align-items-center justify-content-center gap-1">
              <p-button
                variant="outlined"
                severity="secondary"
                size="small"
                icon="pi pi-clock"
                aria-label="Thời gian hiện tại"
                pTooltip="Thời gian hiện tại"
                tooltipPosition="bottom"
                (click)="
                  onSetCurrentTimeForDatepicker(index, FORM_GROUP_KEYS.endTime)
                "
              />

              <p-datepicker
                [formControlName]="FORM_GROUP_KEYS.endTime"
                [showTime]="true"
                hourFormat="24"
                dateFormat="dd/mm"
                appendTo="body"
              >
              </p-datepicker>
            </div>
          </td>

          <td>
            <div>
              <input
                pInputText
                appWorkDuration
                [formControlName]="FORM_GROUP_KEYS.duration"
                [formGroup]="createFormGroup"
              />
            </div>
          </td>

          <!-- Danh sách nút hành động của Thêm mới -->
          <td>
            <div class="flex align-items-center justify-content-between gap-1">
              <p-button
                variant="outlined"
                severity="secondary"
                size="small"
                icon="pi pi-times"
                aria-label="Xóa dữ liệu"
                pTooltip="Xóa dữ liệu"
                tooltipPosition="bottom"
                (click)="onResetCreateForm()"
              />
              <p-button
                variant="outlined"
                severity="secondary"
                size="small"
                icon="pi pi-save"
                aria-label="Lưu"
                pTooltip="Lưu"
                tooltipPosition="bottom"
                (click)="onSaveCreate()"
              />
            </div>
          </td>
        </tr>
      </ng-template>

      <!--  TABLE ROW DATA -->
      <ng-template
        pTemplate="body"
        let-formGroup
        let-index="rowIndex"
        let-expanded="expanded"
      >
        @if (formGroup.value.mode === EMode.VIEW) {
          <!-- Chế độ VIEW chỉ hiển thị text -->

          <tr>
            <td>
              <p-button
                type="button"
                pRipple
                [pRowToggler]="formGroup"
                [text]="true"
                [rounded]="true"
                [plain]="true"
                [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'" />
            </td>
            @for (col of headerColumnConfigs; track col.field) {
              @if (col.field
              === COLUMN_FIELD.no) {
                <td>{{ index + 1 }}</td>
              } @else if (col.field === COLUMN_FIELD.moduleId) {
                <td>
                  {{
                    formGroup.value[col.field]
                      | convertIdToName
                      : (allDropdownData$ | async)?.modules
                        : 'moduleName'
                  }}
                </td>
              } @else if (col.field === COLUMN_FIELD.menuId) {
                <td>
                  {{
                    formGroup.value[col.field]
                      | convertIdToName
                      : (allDropdownData$ | async)?.menus
                        : 'menuName'
                  }}
                </td>
              } @else if (col.field === COLUMN_FIELD.screenId) {
                <td>
                  {{
                    formGroup.value[col.field]
                      | convertIdToName
                      : (allDropdownData$ | async)?.screens
                        : 'screenName'
                  }}
                </td>
              } @else if (col.field === COLUMN_FIELD.featureId) {
                <td>
                  {{
                    formGroup.value[col.field]
                      | convertIdToName
                      : (allDropdownData$ | async)?.features
                        : 'featureName'
                  }}
                </td>
              } @else if (col.field === COLUMN_FIELD.categoryId) {
                <td>
                  {{
                    formGroup.value[col.field]
                      | convertIdToName
                      : (allDropdownData$ | async)?.categories
                        : 'categoryName'
                  }}
                </td>
              } @else if (col.field === COLUMN_FIELD.startTime || col.field ===
              COLUMN_FIELD.endTime) {
                <td>{{ formGroup.value[col.field] | formatDate }}</td>
              } @else if (col.field === COLUMN_FIELD.categoryId) {
                <td>
                  <p-tag
                    [severity]="formGroup.value[col.field] ? 'danger' : 'success'"
                    [value]="formGroup.value[col.field] ? 'Có' : 'Không'"
                  />
                </td>
              } @else if (col.field === COLUMN_FIELD.duration) {
                <td>{{ formGroup.value[col.field] | roundNumber }}</td>
              } @else if (col.field === COLUMN_FIELD.actions) {
                <td>
                  <div class="flex align-items-center justify-content-between gap-1">
                    <p-button
                      variant="outlined"
                      severity="secondary"
                      size="small"
                      icon="pi pi-check-square"
                      aria-label="Đánh dấu đã xong"
                      pTooltip="Đánh dấu đã xong"
                      tooltipPosition="bottom"
                      (click)="onMarkFinish()"
                    />
                    <p-button
                      variant="outlined"
                      severity="secondary"
                      size="small"
                      icon="pi pi-file-edit"
                      aria-label="Chỉnh sửa"
                      pTooltip="Chỉnh sửa"
                      tooltipPosition="bottom"
                      (click)="onChangeToUpdateMode(index)"
                    />
                    <p-button
                      variant="outlined"
                      severity="secondary"
                      size="small"
                      icon="pi pi-trash"
                      aria-label="Xóa"
                      pTooltip="Xóa"
                      tooltipPosition="bottom"
                      (click)="onDelete(formGroup.value)"
                    />
                  </div>
                </td>
              } @else {
                <td>
                  <div
                    class="line-clamp line-clamp-1"
                    [pTooltip]="formGroup.value[col.field]"
                  >
                    {{ formGroup.value[col.field] }}
                  </div>
                </td>
              }
            }
          </tr>
        } @else {
          <!-- Hiển thị Form Update / Form cập nhật -->
          <tr [formGroup]="formGroup">
            <td>
              <p-button
                type="button"
                pRipple
                [pRowToggler]="formGroup.value"
                [text]="true"
                [rounded]="true"
                [plain]="true"
                [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'" />
            </td>
            <td>
              <div class="flex align-items-center justify-content-between gap-1">
                <p-button
                  variant="outlined"
                  severity="secondary"
                  size="small"
                  icon="pi pi-save"
                  aria-label="Lưu"
                  pTooltip="Lưu"
                  tooltipPosition="bottom"
                  (click)="onSaveCreate()"
                />
              </div>
            </td>

            <td>
              <div>
                <lib-form-select
                  #moduleId
                  [formControlName]="FORM_GROUP_KEYS.moduleId"
                  [options]="(moduleDependentOptions$ | async)?.[projectFormControl().value]"
                ></lib-form-select>
              </div>
            </td>

            <td>
              <div>
                <lib-form-select
                  #menuId
                  [formControlName]="FORM_GROUP_KEYS.menuId"
                  [options]="(menuDependentOptions$ | async)?.[moduleId.value]"
                ></lib-form-select>
              </div>
            </td>

            <td>
              <div>
                <lib-form-select
                  #screenId
                  [formControlName]="FORM_GROUP_KEYS.screenId"
                  [options]="(screenDependentOptions$ | async)?.[menuId.value]"
                ></lib-form-select>
              </div>
            </td>

            <td>
              <div>
                <lib-form-select
                  [formControlName]="FORM_GROUP_KEYS.featureId"
                  [options]="(featureDependentOptions$ | async)?.[screenId.value]"
                ></lib-form-select>
              </div>
            </td>

            <td>
              <div>
                <lib-form-select
                  [formControlName]="FORM_GROUP_KEYS.categoryId"
                  [options]="(categoryOptions$ | async) || []"
                ></lib-form-select>
              </div>
            </td>

            <td>
              <div>
              <textarea
                pTextarea
                [formControlName]="FORM_GROUP_KEYS.issueName"
                rows="1"
                cols="30"
              ></textarea>
              </div>
            </td>

            <td>
              <div>
                <lib-form-select
                  [formControlName]="FORM_GROUP_KEYS.departmentMakeId"
                  [options]="(categoryOptions$ | async) || []"
                ></lib-form-select>
              </div>
            </td>


            <td>
              <div>
                <lib-form-select
                  [formControlName]="FORM_GROUP_KEYS.employeeMakeId"
                  [options]="(categoryOptions$ | async) || []"
                ></lib-form-select>
              </div>
            </td>

            <td>
              <div>
                <lib-form-select
                  [formControlName]="FORM_GROUP_KEYS.interruptionReasonId"
                  [options]="(categoryOptions$ | async) || []"
                ></lib-form-select>
              </div>
            </td>

            <td>
              <div>
                <lib-form-select
                  [formControlName]="FORM_GROUP_KEYS.deadlineId"
                  [options]="(categoryOptions$ | async) || []"
                ></lib-form-select>
              </div>
            </td>

            <td>
              <div class="flex align-items-center justify-content-center gap-1">
                <p-button
                  variant="outlined"
                  severity="secondary"
                  size="small"
                  icon="pi pi-clock"
                  aria-label="Thời gian hiện tại"
                  pTooltip="Thời gian hiện tại"
                  tooltipPosition="bottom"
                  (click)="
                  onSetCurrentTimeForDatepicker(
                    index,
                    FORM_GROUP_KEYS.startTime
                  )
                "
                />
                <p-datepicker
                  [formControlName]="FORM_GROUP_KEYS.startTime"
                  [showTime]="true"
                  hourFormat="24"
                  dateFormat="dd/mm"
                  appendTo="body"
                >
                </p-datepicker>
              </div>
            </td>

            <td>
              <div class="flex align-items-center justify-content-center gap-1">
                <p-button
                  variant="outlined"
                  severity="secondary"
                  size="small"
                  icon="pi pi-clock"
                  aria-label="Thời gian hiện tại"
                  pTooltip="Thời gian hiện tại"
                  tooltipPosition="bottom"
                  (click)="
                  onSetCurrentTimeForDatepicker(index, FORM_GROUP_KEYS.endTime)
                "
                />

                <p-datepicker
                  [formControlName]="FORM_GROUP_KEYS.endTime"
                  [showTime]="true"
                  hourFormat="24"
                  dateFormat="dd/mm"
                  appendTo="body"
                >
                </p-datepicker>
              </div>
            </td>

            <td>
              <div>
                <input
                  pInputText
                  appWorkDuration
                  [formControlName]="FORM_GROUP_KEYS.duration"
                  [formGroup]="createFormGroup"
                />
              </div>
            </td>

            <!-- Danh sách nút hành động của Thêm mới -->
            <td>
              <div class="flex align-items-center justify-content-between gap-1">
                <p-button
                  variant="outlined"
                  severity="secondary"
                  size="small"
                  icon="pi pi-times"
                  aria-label="Xóa dữ liệu"
                  pTooltip="Xóa dữ liệu"
                  tooltipPosition="bottom"
                  (click)="onResetCreateForm()"
                />
                <p-button
                  variant="outlined"
                  severity="secondary"
                  size="small"
                  icon="pi pi-save"
                  aria-label="Lưu"
                  pTooltip="Lưu"
                  tooltipPosition="bottom"
                  (click)="onSaveCreate()"
                />
              </div>
            </td>
          </tr>
        }
      </ng-template>

      <ng-template #expandedrow let-product>
        <tr>
          <td colspan="12">
            <app-log-work
              [formGroupControl]="formGroup"
              [projectFormControl]="projectFormControl()"
            >
            </app-log-work>
          </td>
        </tr>
      </ng-template>

    </p-table>
  </div>
</div>
